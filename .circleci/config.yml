version: 2.1 

jobs:
  run-tests:
    parameters:
      org_alias:
        type: string
      login_script:
        type: string
    docker:
      - image: circleci/node:latest
    steps:
      - checkout
      - restore_cache:
          keys:
            - dependency-cache-{{ checksum "package.json" }}
            - dependency-cache-
      - run:
          name: Install Dependencies
          command: . build/install_dependencies.sh
      - save_cache:
          key: dependency-cache-{{ checksum "package.json" }}
          paths:
            - node_modules
      - run: 
          name: Login to Org
          command: . build/<< parameters.login_script >>
      - run:
          name: Run Apex Tests
          command: . build/run_apex_tests.sh << parameters.org_alias >>
      - store_test_results:
          path: test-results

  code-review:
    docker:
      - image: circleci/node:latest
    steps:
      - checkout
      - restore_cache:
          keys:
            - dependency-cache-{{ checksum "package.json" }}
            - dependency-cache-
      - run:
          name: Install Dependencies
          command: . build/install_dependencies.sh
      - save_cache:
          key: dependency-cache-{{ checksum "package.json" }}
          paths:
            - node_modules
      - run:
          name: SFDX Scanner Analysis
          command: . build/run_sfdx_scanner.sh
      - store_artifacts:
          path: sfdxScannerAnalysis.csv
      - store_artifacts:
          path: test-results

  deploy-code:
    parameters:
      org_alias:
        type: string
      login_script:
        type: string
      deploy_script:
        type: string
    docker:
      - image: circleci/node:latest
    steps:
      - checkout
      - restore_cache:
          keys:
            - dependency-cache-{{ checksum "package.json" }}
            - dependency-cache-
      - run:
          name: "Install Dependencies"
          command: . build/install_dependencies.sh
      - save_cache:
          key: dependency-cache-{{ checksum "package.json" }}
          paths:
            - node_modules
      - run: 
          name: Login to Org
          command: . build/<< parameters.login_script >>
      - run:
          name: Deploy to Org
          command: . build/<< parameters.deploy_script >>

workflows:
  version: 2
  
  # Development Sandbox - Auto deploy
  dev-pipeline:
    jobs:
      - run-tests:
          name: test-dev
          org_alias: "DevSandbox"
          login_script: "login_to_dev_sandbox.sh"
          filters:
            branches:
              only: dev
      - code-review:
          name: review-dev
          requires:
            - test-dev
          filters:
            branches:
              only: dev
      - deploy-code:
          name: deploy-dev
          org_alias: "DevSandbox"
          login_script: "login_to_dev_sandbox.sh"
          deploy_script: "deploy_to_dev.sh"
          requires:
            - review-dev
          filters:
            branches:
              only: dev

  # Full Sandbox - Team Lead approval
  full-sandbox-pipeline:
    jobs:
      - run-tests:
          name: test-full
          org_alias: "FullSandbox"
          login_script: "login_to_full_sandbox.sh"
          filters:
            branches:
              only: full
      - code-review:
          name: review-full
          requires:
            - test-full
          filters:
            branches:
              only: full
      - hold-for-full-approval:
          type: approval
          requires:
            - review-full
          filters:
            branches:
              only: full
      - deploy-code:
          name: deploy-full
          org_alias: "FullSandbox"
          login_script: "login_to_full_sandbox.sh"
          deploy_script: "deploy_to_full.sh"
          requires:
            - hold-for-full-approval
          filters:
            branches:
              only: full

  # Prod Prep - Manager manually triggers (no automatic trigger)
  prodprep-deployment:
    triggers:
    - schedule:
        cron: "0 0 31 2 *"  # Never runs automatically
        filters:
          branches:
            only: prodprep
    jobs:
      - run-tests:
          name: test-prodprep
          org_alias: "ProdPrepSandbox"
          login_script: "login_to_prodprep_sandbox.sh"
          filters:
            branches:
              only: prodprep
      - code-review:
          name: review-prodprep
          requires:
            - test-prodprep
          filters:
            branches:
              only: prodprep
      - manager-approve-prodprep:
          type: approval
          requires:
            - review-prodprep
          filters:
            branches:
              only: prodprep
      - deploy-code:
          name: deploy-prodprep
          org_alias: "ProdPrepSandbox"
          login_script: "login_to_prodprep_sandbox.sh"
          deploy_script: "deploy_to_prodprep.sh"
          requires:
            - manager-approve-prodprep
          filters:
            branches:
              only: prodprep

  # Production - Manager manually triggers (no automatic trigger)
  production-deployment:
    triggers:
    - schedule:
        cron: "0 0 31 2 *"  # Never runs automatically
        filters:
          branches:
            only: master
    jobs:
      - run-tests:
          name: test-production
          org_alias: "Production"
          login_script: "login_to_production.sh"
          filters:
            branches:
              only: master
      - code-review:
          name: review-production
          requires:
            - test-production
          filters:
            branches:
              only: master
      - manager-approve-production:
          type: approval
          requires:
            - review-production
          filters:
            branches:
              only: master
      - deploy-code:
          name: deploy-production
          org_alias: "Production"
          login_script: "login_to_production.sh"
          deploy_script: "deploy_to_production.sh"
          requires:
            - manager-approve-production
          filters:
            branches:
              only: master